<!-- [JST 2026-01-05 15:00] index.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>見積入力（Firebase勉強用 / 1画面完結）</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:14px;}
    h1{font-size:18px;margin:0 0 10px;}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .f{flex:1;min-width:200px}
    label{display:block;font-size:12px;color:#444;margin:0 0 4px}
    input{width:100%;box-sizing:border-box;padding:10px;font-size:16px}
    button{padding:10px 14px;font-size:15px;cursor:pointer}
    .muted{color:#666;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:8px;font-size:14px;vertical-align:top}
    th{background:#f5f5f5}
    .right{text-align:right}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .danger{border-color:#c00;color:#c00}
    .ok{color:#0a0}
    .warn{color:#a60}
    .hidden{display:none !important}
    .smallbtn{padding:6px 10px;font-size:13px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <h1>見積入力（Firebase勉強用 / 1画面完結）</h1>

  <!-- 状態表示 -->
  <div class="card">
    <div class="toolbar">
      <div>状態：<span id="authState" class="warn">未ログイン</span></div>
      <div class="muted">uid: <span id="uid" class="mono">-</span></div>
      <div class="muted">email: <span id="email" class="mono">-</span></div>
      <div style="margin-left:auto">
        <button id="btnLogout" class="smallbtn hidden" type="button">ログアウト</button>
      </div>
    </div>
    <div class="muted" id="statusMsg">準備中...</div>
  </div>

  <!-- ログイン領域 -->
  <div class="card" id="loginCard">
    <h2 style="font-size:16px;margin:0 0 10px">ログイン / 新規登録（メール＋パスワード）</h2>
    <div class="row">
      <div class="f">
        <label>メール（ID）</label>
        <input id="loginEmail" type="email" placeholder="example@example.com" autocomplete="username" />
      </div>
      <div class="f">
        <label>パスワード</label>
        <input id="loginPass" type="password" placeholder="8文字以上推奨" autocomplete="current-password" />
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="btnSignIn" type="button">ログイン</button>
      <button id="btnSignUp" type="button">新規登録</button>
      <button id="btnReset"  type="button">パスワード再設定メール</button>
      <span class="muted">※勉強用：メールアドレス宛に再設定リンクを送ります</span>
    </div>
  </div>

  <!-- アプリ領域（ログイン後に表示） -->
  <div class="card hidden" id="appCard">
    <h2 style="font-size:16px;margin:0 0 10px">見積（最小）</h2>

    <!-- 入力フォーム（新規/編集 共通） -->
    <div class="row">
      <div class="f">
        <label>件名（title）</label>
        <input id="title" type="text" placeholder="例：テスト見積" />
      </div>
      <div class="f">
        <label>合計（total / 数値）</label>
        <input id="total" type="number" inputmode="numeric" placeholder="例：1000" />
      </div>
    </div>

    <div class="toolbar" style="margin-top:10px">
      <button id="btnSave" type="button">追加</button>
      <button id="btnCancelEdit" class="hidden" type="button">キャンセル（編集解除）</button>
      <span class="muted">モード：<span id="modeLabel" class="mono">create</span></span>
      <span class="muted">editingId：<span id="editingIdLabel" class="mono">-</span></span>
    </div>

    <!-- 一覧 -->
    <table>
      <thead>
        <tr>
          <th style="width:170px">作成日</th>
          <th>件名</th>
          <th style="width:120px" class="right">合計</th>
          <th style="width:160px">操作</th>
        </tr>
      </thead>
      <tbody id="listBody">
        <tr><td colspan="4" class="muted">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Firebase SDK（v9 compat：単一HTMLで扱いやすい） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // [CFG] ここだけ差し替え
    // =============================
    const firebaseConfig = {
      // ↓ Firebaseコンソールで表示されている firebaseConfig をそのまま貼る
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };

    // =============================
    // 初期化
    // =============================
    const el = (id) => document.getElementById(id);
    function setStatus(msg){ el("statusMsg").textContent = msg; }

    let app, auth, db;
    let unsubscribe = null;

    // 1画面の状態
    let mode = "create";       // "create" | "edit"
    let editingId = null;      // edit時の docId

    function setModeCreate(){
      mode = "create";
      editingId = null;
      el("modeLabel").textContent = mode;
      el("editingIdLabel").textContent = "-";
      el("btnSave").textContent = "追加";
      el("btnCancelEdit").classList.add("hidden");
      el("title").value = "";
      el("total").value = "";
    }

    function setModeEdit(docId, data){
      mode = "edit";
      editingId = docId;
      el("modeLabel").textContent = mode;
      el("editingIdLabel").textContent = docId;
      el("btnSave").textContent = "更新";
      el("btnCancelEdit").classList.remove("hidden");
      el("title").value = data.title || "";
      el("total").value = (typeof data.total === "number") ? data.total : "";
    }

    function fmtYen(n){
      try{
        const s = Math.round(n).toString();
        return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }catch(_){ return String(n); }
    }

    function requireConfig(){
      if(!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId){
        throw new Error("firebaseConfig が未設定です。Firebaseコンソールのコードを貼り付けてください。");
      }
    }

    function initFirebase(){
      requireConfig();
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      setStatus("Firebase 初期化完了。認証状態を確認中...");
    }

    // =============================
    // 認証
    // =============================
    async function signIn(){
      const email = el("loginEmail").value.trim();
      const pass  = el("loginPass").value;
      if(!email || !pass){ alert("メールとパスワードを入力してください。"); return; }
      await auth.signInWithEmailAndPassword(email, pass);
    }

    async function signUp(){
      const email = el("loginEmail").value.trim();
      const pass  = el("loginPass").value;
      if(!email || !pass){ alert("メールとパスワードを入力してください。"); return; }
      await auth.createUserWithEmailAndPassword(email, pass);
    }

    async function resetPass(){
      const email = el("loginEmail").value.trim();
      if(!email){ alert("メール（ID）を入力してください。"); return; }
      await auth.sendPasswordResetEmail(email);
      alert("パスワード再設定メールを送信しました。受信ボックスを確認してください。");
    }

    async function logout(){
      await auth.signOut();
    }

    // =============================
    // Firestore CRUD（最小）
    // =============================
    async function saveQuote(){
      const user = auth.currentUser;
      if(!user){ alert("未ログインです。"); return; }

      const title = el("title").value.trim();
      const totalRaw = el("total").value;
      const total = Number(totalRaw);

      if(!title){ alert("件名（title）を入力してください。"); return; }
      if(!isFinite(total)){ alert("合計（total）は数値で入力してください。"); return; }

      const now = firebase.firestore.FieldValue.serverTimestamp();

      if(mode === "create"){
        await db.collection("quotes").add({
          title,
          total,
          ownerUid: user.uid,
          createdAt: now,
          updatedAt: now
        });
        setModeCreate();
      }else{
        if(!editingId){ alert("editingId がありません。"); setModeCreate(); return; }
        await db.collection("quotes").doc(editingId).update({
          title,
          total,
          ownerUid: user.uid, // ルール整合のため維持
          updatedAt: now
        });
        setModeCreate();
      }
    }

    async function deleteQuote(docId){
      const ok = confirm("削除します。よろしいですか？");
      if(!ok) return;
      await db.collection("quotes").doc(docId).delete();
      if(mode === "edit" && editingId === docId){
        setModeCreate();
      }
    }

    function subscribeQuotes(){
      const user = auth.currentUser;
      if(!user) return;

      if(unsubscribe){ unsubscribe(); unsubscribe = null; }

      setStatus("Firestore から一覧を読み込み中...");
      const q = db.collection("quotes")
        .where("ownerUid", "==", user.uid)
        .orderBy("createdAt", "desc");

      unsubscribe = q.onSnapshot((snap) => {
        const tbody = el("listBody");
        while(tbody.firstChild) tbody.removeChild(tbody.firstChild);

        if(snap.empty){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.className = "muted";
          td.textContent = "データがありません。上のフォームから追加してください。";
          tr.appendChild(td);
          tbody.appendChild(tr);
          setStatus("一覧：0件");
          return;
        }

        let count = 0;
        snap.forEach((doc) => {
          count++;
          const data = doc.data() || {};
          const tr = document.createElement("tr");

          // createdAt
          const tdDate = document.createElement("td");
          let dt = "-";
          if(data.createdAt && data.createdAt.toDate){
            const d = data.createdAt.toDate();
            dt = d.getFullYear() + "/" + String(d.getMonth()+1).padStart(2,"0") + "/" + String(d.getDate()).padStart(2,"0")
               + " " + String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0");
          }
          tdDate.textContent = dt;
          tr.appendChild(tdDate);

          // title
          const tdTitle = document.createElement("td");
          tdTitle.textContent = data.title || "";
          tr.appendChild(tdTitle);

          // total
          const tdTotal = document.createElement("td");
          tdTotal.className = "right";
          tdTotal.textContent = isFinite(Number(data.total)) ? (fmtYen(Number(data.total)) + " 円") : "";
          tr.appendChild(tdTotal);

          // actions
          const tdAct = document.createElement("td");
          const btnE = document.createElement("button");
          btnE.type = "button";
          btnE.className = "smallbtn";
          btnE.textContent = "編集";
          btnE.onclick = () => setModeEdit(doc.id, data);

          const btnD = document.createElement("button");
          btnD.type = "button";
          btnD.className = "smallbtn danger";
          btnD.textContent = "削除";
          btnD.style.marginLeft = "6px";
          btnD.onclick = () => deleteQuote(doc.id);

          tdAct.appendChild(btnE);
          tdAct.appendChild(btnD);
          tr.appendChild(tdAct);

          tbody.appendChild(tr);
        });

        setStatus("一覧：" + count + "件");
      }, (err) => {
        console.error(err);
        setStatus("Firestore 読み込みエラー: " + (err && err.message ? err.message : err));
        alert("Firestore 読み込みエラー。\n" + (err && err.message ? err.message : err));
      });
    }

    // =============================
    // UI 結線
    // =============================
    function bindUI(){
      el("btnSignIn").onclick = async () => {
        try{ await signIn(); }catch(e){ alert(e.message || e); }
      };
      el("btnSignUp").onclick = async () => {
        try{ await signUp(); }catch(e){ alert(e.message || e); }
      };
      el("btnReset").onclick = async () => {
        try{ await resetPass(); }catch(e){ alert(e.message || e); }
      };
      el("btnLogout").onclick = async () => {
        try{ await logout(); }catch(e){ alert(e.message || e); }
      };
      el("btnSave").onclick = async () => {
        try{ await saveQuote(); }catch(e){ alert(e.message || e); }
      };
      el("btnCancelEdit").onclick = () => setModeCreate();
    }

    // =============================
    // 認証状態監視（画面切替）
    // =============================
    function watchAuth(){
      auth.onAuthStateChanged((user) => {
        if(!user){
          el("authState").textContent = "未ログイン";
          el("authState").className = "warn";
          el("uid").textContent = "-";
          el("email").textContent = "-";

          el("btnLogout").classList.add("hidden");
          el("loginCard").classList.remove("hidden");
          el("appCard").classList.add("hidden");

          if(unsubscribe){ unsubscribe(); unsubscribe = null; }
          setStatus("ログインしてください。");
          setModeCreate();
          return;
        }

        el("authState").textContent = "ログイン中";
        el("authState").className = "ok";
        el("uid").textContent = user.uid;
        el("email").textContent = user.email || "-";

        el("btnLogout").classList.remove("hidden");
        el("loginCard").classList.add("hidden");
        el("appCard").classList.remove("hidden");

        setModeCreate();
        subscribeQuotes();
      });
    }

    // =============================
    // 起動
    // =============================
    (function main(){
      try{
        initFirebase();
        bindUI();
        watchAuth();
        setStatus("準備完了。ログインして操作してください。");
      }catch(e){
        console.error(e);
        setStatus("起動エラー: " + (e.message || e));
        alert("起動エラー: " + (e.message || e));
      }
    })();
  </script>
</body>
</html>
